Это инструкция для **Ubuntu** (Linux) о том как установить и настроить программу **DNSCRYPT** для шифрования DNS запросов и использовать независимые DNS сервера с DNS записями собранными активистами и в теории не содержащими **рекламы** или каких-то **блокированных** DNS записей.

- [Что такое DNS CRYPT (DNSCRYPT)?](#Что-такое-DNS-CRYPT-DNSCRYPT)
- [Почему это нужно использовать?](#Почему-это-нужно-использовать)
- [Как установить и настроить DNS CRYPT](#Как-установить-и-настроить-DNS-CRYPT)
- [Если у вас все равно не работает или почему не нужно использовать DoH (включен DoH, DNS over HTTPS)](#Если-у-вас-все-равно-не-работает-или-почему-не-нужно-использовать-DoH-включен-DoH-DNS-over-HTTPS)
- [Про порт DNS сервера 53 и про то что лучше использовать другой](#Про-порт-DNS-сервера-53-и-про-то-что-лучше-использовать-другой)

# Что такое DNS CRYPT (DNSCRYPT)?

**DNSCRYPT** - это программа, работает как прокси для DNS запросов, которые отправляются программами на сервера провайдера (или другие указанные в настройках сервера) и по имени сайта получают его IP чтобы знать куда идти.

# Почему это нужно использовать?

Провайдеры через их DNS сервера или сторонние DNS сервера **могут** использовать DNS чтобы **отслеживать** пользователя, **блокировать сайты** (возвращая неверный ответ), **показывать рекламу** (возвращая IP сайтов с рекламой). Отслеживать и блокировать они могут и по IP, но через DNS это проще.

# Как установить и настроить DNS CRYPT

1. Скачать последнюю версию отсюда `https://github.com/jedisct1/dnscrypt-proxy/releases` и распаковать в `/opt/dnscrypt-proxy/`
   * **Почему я не предлагаю устанавливать из PPA для Ubuntu, который указан на сайте разработчика:** потому что PPA неофициальный и вызывает сомнения, а просто скачать и запустить программу не так сложно чтобы идти на риск. Этот PPA не такой популярный как у более распространенных программ, поэтому если появятся вредоносные вставки, то они будут выявлены с большой задержкой.
2. Переименовать файл `/opt/dnscrypt-proxy/example-dnscrypt-proxy.toml` в `/opt/dnscrypt-proxy/dnscrypt-proxy.toml`
3. в файле `dnscrypt-proxy.toml` найти поиском и установить опции:
    ```toml
    doh_servers = false
    require_dnssec = true
    require_nolog = true
    require_nofilter = true
    ignore_system_dns = true
    ```
4. Раскомментировать и установить опцию `server_names` (убрав решетки перед ней) и установить ей значения:  `server_names = ['scaleway-fr', 'bottlepost-dns-nl', 'dnscrypt.nl-ns0']`  
**где** строки: `'scaleway-fr', 'bottlepost-dns-nl', 'dnscrypt.nl-ns0'` - это имена серверов из списка https://dnscrypt.info/public-servers/ (в файле настроек `dnscrypt-proxy.toml` прописан url на этот список в текстовом виде, а на сайте вид удобнее).
    * Можете выбирать  сервера из писка сами, нужно выбирать те для которых стоит в их описании: `dnssec`, `no log`, `no filter` (**dnssec** - расширение для шифрования DNS запросов, **no log** - не ведутся логи запросов, **no filter** - нет цензуры)
5. установить в настройках сети `Auto (ip only)` чтобы не подставляло dns сервер само и вписать в список dns серверов адрес `127.0.0.1`, порт **53** будет использован для DNS по умолчанию, его не нужно писать.
6. проверить на сайте https://browserleaks.com/ip какие dns сервера используются (нужно чтобы отображались те что в списке)
7. установить dnscrypt-proxy как сервис командой `sudo /opt/dnscrypt-proxy/dnscrypt-proxy -service install`
8. запустить dnscrypt-proxy как сервис командой (просто установить недостаточно, нужен запуск) `sudo /opt/dnscrypt-proxy/dnscrypt-proxy -service start`
9. После перезагрузки сервис уже будет работать, его не нужно добавлять в авто загрузку вручную. Проверить работает или нет можно командой `systemctl status dnscrypt-proxy`

**Остановить** этот сервис можно командой `sudo /opt/dnscrypt-proxy/dnscrypt-proxy -service stop`

Чтобы DNS **заработало** если не запущен dnscrypt нужно удалить установленный по этой инструкции адрес `127.0.0.1` DNS сервера из настроек сети.

Предлагаю **выбирать сервера** из списка с текстом в названиях: `.nl, -nl, -fr, .fr` это сервера **Нидерландов** или **Франции** (используйте поиск `ctrl+F` по странице чтобы найти такие записи)

# Если у вас все равно не работает или почему не нужно использовать DoH (включен DoH, DNS over HTTPS)

**DoH** (DNS over HTTPS) - это тоже шифрование DNS, но без обращение к DNS системы, а используя отдельные запросы.

Некоторые браузеры или программы **могу** подключаться к своим DNS серверам в обход системных настроек. Чтобы они использовали **DNS системы** (и программы **dnscryt** соответственно) нужно указать в их настроках использовать системные DNS. Как это сделать ищите для каждой конкретной программы в Интернете отдельно.

**Проблема встроенного DoH** в том что каждая программа использует DNS сервера своего разработчика. Которые также могут содержать цензуру или рекламу.

Для **Mozilla Firefox** на странице `about:config` нужно установить опцию `network.trr.mode` в значение `0` (или в значение `5` если `0` не сработал) чтобы отключить DoH. Чтобы вернуть настройки назад нужно кликнуть правой кнопкой мыши на этой опции и выбрать `Reset`.

# Про порт DNS сервера 53 и про то что лучше использовать другой

Порт `53` для DNS системы стоит по умолчанию и изменить его в некоторых системах это проблема. Лучше использовать порт например `53000`, но с настройкой много возни.