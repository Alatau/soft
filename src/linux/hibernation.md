- [Что это?](#Что-это)
- [1. Включаем Hibernate](#1-Включаем-hibernate)
  - [1. Настраиваем размер и точку мантирования файла /swapfile подкачки](#1-Настраиваем-размер-и-точку-мантирования-файла-swapfile-подкачки)
  - [Вариант 1 (ядро Linux) или Вариант 2 (утилита uswsusp)? Что выбрать?](#Вариант-1-ядро-linux-или-Вариант-2-утилита-uswsusp-Что-выбрать)
  - [2. (Вариант 1), Настройка Hibernation (спящего режима) из ядра Linux](#2-Вариант-1-Настройка-hibernation-спящего-режима-из-ядра-linux)
    - [1. Подготовка](#1-Подготовка)
    - [2. Указываем где `/swapfile` с которого загружаться](#2-Указываем-где-swapfile-с-которого-загружаться)
    - [3. Устанавливаем размер образа системы и отключаем сжатие](#3-Устанавливаем-размер-образа-системы-и-отключаем-сжатие)
  - [2. (Вариант 2), Настройка Hibernation (спящего режима) через утилиту uswsusp](#2-Вариант-2-Настройка-hibernation-спящего-режима-через-утилиту-uswsusp)
    - [1. Установка](#1-Установка)
    - [2. Настраиваем утилиту uswsusp](#2-Настраиваем-утилиту-uswsusp)
    - [3. Указываем swapfile системе](#3-Указываем-swapfile-системе)
    - [3. Заменяем стандартную функцию hibernation утилитой uswsusp](#3-Заменяем-стандартную-функцию-hibernation-утилитой-uswsusp)
- [2. Добавляем hibernation в пункты меню питания системы](#2-Добавляем-hibernation-в-пункты-меню-питания-системы)
- [3. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)](#3-Устанавливаем-время-загрузки-системы-при-пробуждении-в-случае-проблем-чтобы-не-ждать-долго)
- [Известные проблемы](#Известные-проблемы)

# Что это?

Краткая инструкция по включению Hibernation (спящего режима) в Ubuntu 18.04 и выше (вообще для любых редакций со swapfile вместо swap раздела).

# 1. Включаем Hibernate

## 1. Настраиваем размер и точку мантирования файла /swapfile подкачки

**Зачем:** чтобы образ сохраняемой системы при засыпании поместился на в swapfile. И чтобы система могла его найти, чтобы загрузиться с него.

**1. Увеличиваем `/swapfile` подкачки.** Это нужно чтобы образ вошедшей в hibernate системы поместился в `/swapfile`. При пробуждении образ будет восстановлен из этого файла.

**Какой размер `/swapfile` выбрать:** в 2 раза больше чем у вас оперативной памяти (вместо 16 гигабайт в команды ниже поставите нужный размер).
```bash
# смотрим информацию о памяти
free -m                             # информация о оперативной памяти

# увеличиваем до 16 Gb (выполнить команды, вместо 16 подставить свое)
sudo swapoff /swapfile              # отключаем swap
sudo fallocate -l 16G /swapfile     # увеличиваем размер swap
sudo chown root:root /swapfile      # устанавливаем владельцем root
sudo chmod 600 /swapfile            # устанавливаем права доступа
sudo mkswap /swapfile               # форматируем файл в swap тип
sudo swapon /swapfile               # включаем swap

# проверяем что получилось
sudo swapon --show                  # смотрим что создалось
free -m                             # информация о оперативной памяти
cat /proc/swaps                     # информация о состоянии swap
```

**2. Добавим точку монтирования `/swapfile` в `/etc/fstab`**, чтобы система  могла видеть swap файл и использовать его во время загрузки.

1. Открываем файл: `sudo geany /etc/fstab`
2. Увидим там строку: `/swapfile none swap sw 0 0`. Заменить ее на строку: ```/swapfile   swap    swap    defaults        0       0```
3. Сохранить файл. Перемонтировать диски из `/etc/fstab`, если там не стоит `noauto` выполнив команду: `sudo mount -a`
4. Если команда `sudo mount -a` не сработала, то на этом шаге перезагрузите систему

## Вариант 1 (ядро Linux) или Вариант 2 (утилита uswsusp)? Что выбрать?

Выбирайте **uswsusp** (**Вариант 2**), если с ней будут проблемы удалите все изменения, выполните команду `sudo update-initramfs -u` чтобы их применить и перезагрузите систему. После этого пробуйте **Вариант 1**.

## 2. (Вариант 1), Настройка Hibernation (спящего режима) из ядра Linux

### 1. Подготовка
Устанавливаем **geany** для удобного редактирования файлов конфигурации. И просто запускаем **1-ин раз не от sudo**, иначе файл конфигураций создастся от sudo и сохранение настроек не будет доступно обычному пользователю.

Чтобы исправить проблему с сохранение конфигурации не от sudo нужно удалить файл конфигурации `sudo rm -rf /home/<user>/.config/geany` и запустить 1-ин раз не от sudo. Где `<user>` это имя вашего пользователя.
```bash
sudo apt install geany
```

### 2. Указываем где `/swapfile` с которого загружаться

1. Получить **UUID** для `/swapfile`
    ```bash
    sudo findmnt -no SOURCE,UUID -T /swapfile
    ```
2. Получить **offset** (смещение) файла `/swapfile` относительно начала диска (смотреть **первое число** в столбце `physical_offset`, это число и есть смещение):
    ```bash
    sudo filefrag -v /swapfile
    ```
3. Открыть конфигурацию grub:
    ```bash
    sudo geany /etc/default/grub
    ```
4. Найти в открытом `/etc/default/grub` слово (опцию) `GRUB_CMDLINE_LINUX_DEFAULT`. **Поставить** в `resume` значение **UUID**, а в `resume_offset` число **offset** (смещение), полученные выше. И добавить это вконец этой опции после знака `=` (равно) внутрь между кавычек отделив пробелом опции `resume` и `resume_offset` как в примере <sub>(`quiet splash` это параметры по умолчанию, их не трогаем)</sub>:
    ```bash
    GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID=e2ea34fc-b23a-4948-b2e6-a5a9a79682e5 resume_offset=34816"
    ```
5. Сохранить файл и выполнить обновление grub:
    ```bash
    sudo update-grub
    ```
6. Перезагрузить систему.

### 3. Устанавливаем размер образа системы и отключаем сжатие

**Зачем:** иначе будет тормозить при пробуждении пока недостающий кусочек памяти не загрузится в оперативную память.

**1. Устанавливаем размер образа сохраняемого в `/swapfile` равным размеру оперативной памяти (в байтах):**

0. Смотрим лимит размера образа системы: `cat /sys/power/image_size`
1. Создаем файл конфигурации `sudo touch /etc/tmpfiles.d/hibernationsize.conf`
2. Открываем созданный файл: `sudo geany /etc/tmpfiles.d/hibernationsize.conf` и вставляем в этот файл текст конфигурации (число 8589934592 это количество **байт** для 8 Гб, размер равный размеру вашей оперативной памяти):
    ```
    #    Path                  Mode UID  GID  Age Argument
    w    /sys/power/image_size     -    -    -    -   8589934592
    ```
3. Сохранить файл. Перезагрузить систему

**Как посчитать нужное число:** 1 Гб это **1073741824** байт, поэтому чтобы получить количество байт для 8 Гб нужно использовать формулу: `8 * 1073741824 = 8589934592` (вместо 8 можете использовать нужное вам число Гб: 4, 8, 16, 32, ...). И именно это полученное число равное количеству гигабайт вашей оперативной памяти умноженной на число  **1073741824** нужно подставить в файл `/etc/tmpfiles.d/hibernationsize.conf` вместо 8589934592 из примера выше.

**2. Отключаем сжатие образа системы:**

1. Открываем `sudo geany /etc/default/grub`
2. Добавляем в опции ядра параметр `hibernate=nocompress`, итоговая строка <sub>(`quiet splash` это параметры по умолчанию, их не трогаем)</sub>:
    ```
    GRUB_CMDLINE_LINUX_DEFAULT="quiet splash hibernate=nocompress resume=UUID=2f7d1692-5348-456d-9317-47147c4ef639 resume_offset=34816"
    ```
3. Обновляем конфигурацию `sudo update-grub`
4. Перезагрузить систему

## 2. (Вариант 2), Настройка Hibernation (спящего режима) через утилиту uswsusp

### 1. Установка
Установим набор утилит (тут будет несколько разных, но мы используем только s2disk для hibernate):
```
sudo apt install uswsusp
```

Удалить:
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash hibernate=nocompress resume=UUID=2f7d1692-5348-456d-9317-47147c4ef639 resume_offset=34816"

### 2. Настраиваем утилиту uswsusp

1. Выполняем команду: `sudo dpkg-reconfigure -pmedium uswsusp`. Должны появиться шаги настройки в текстовом режиме. Команда **может не сработать** с первого раза как надо, не все шаги появятся. Тогда запустить ее еще раз.
2. В появившемся окне выполнять **по шагам**, отвечая на вопросы:
    1. `Continue without a valid swap space?` ответить **Yes** (Да)
    2. `Swap space to resume from:` выбрать именно **РАЗДЕЛ** на котором swapfile создан (а **не путь к файлу**, т.е. выбрать строку вида `/dev/sdaN`, где `N` это номер диска со `/swapfile`. Или `/dev/disk/by-uuid/1212-12DSSF-...`, **а НЕ** строку вида: `/swapfile`)
    3. `Encrypt snapshot?` ответить No (тут могут быть варианты, но лучше выбрать No, а шифрование настроить через LUKS)
3. После выполненных шагов из пункта выше создастся файл настроек hibernation: `/etc/uswsusp.conf`. Выполняем по шагам настройку **uswsusp**:
    1. Откроем файл настроек `sudo geany /etc/uswsusp.conf`
    2. Найдем в открытом файле строку `resume device = `, после равно должна быть строка вида установленного в пункте выше с ответом на вопрос `Swap space to resume from:`. Если на этот вопрос ответили неверно можно сейчас поправить ответ. Строка может иметь вид `/dev/disk/by-uuid/1212-12DSSF-...` или `/dev/sdaN`.
    3. Если нужно поменять путь **к разделу** (диску, но **НЕ ФАЙЛУ**) на котором расположен `/swapfile` нужно выполнить по шагам:
        1. Смотрим раздел на котором расположен `/swapfile`, результат должен быть в виде `/dev/sdaN` сама команда:
            ```
            sudo findmnt -no SOURCE,UUID -T /swapfile
            ```
            Вывод команды (примерный, `/dev/sdaN` это то что нужно вписать, например: `resume device = /dev/sda1`):
            ```
            /dev/sda1 2f7d1692-5348-456d-9317-47147c4ef639
            ```
        2. Найдем позицию в файловой системе (смещение относительно начала диска):
            ```
            sudo swap-offset /swapfile
            ```
            Вывод команды будет примерно таким:
            ```
            resume offset = 34816
            ```
            Этот вывод и нужно записать в файл `/etc/uswsusp.conf`
        3. Установим размер сохраняемого образа системы равным размеру оперативной памяти (`количество_гигабайт_оперативной_памяти * 1073741824`, для 8 Гб это `8 * 1073741824 = 8589934592`). Значит параметр `image size = ` поставить таким:
            ```
            image size = 8589934592
            ```
        4. Можете не выполнять этот пункт, он на выбор. Отключить сжатие образа установив параметр `compress = `
            ```
            compress = n
            ```
    4. Сохранить файл, закрыть и применить настройки командой: `sudo update-initramfs -u`

**Note:** При **любом изменении файла** `/etc/uswsusp.conf` чтобы изменения применились нужно выполнять команду `sudo update-initramfs -u`

**Note:** Если вы используете **LUKS** + **LVM** (шифрованный системный диск), то команда `sudo findmnt -no SOURCE,UUID -T /swapfile` выведет результат вида `/dev/mapper/local-root 5ff24bbe-d819-4dab-ae73-c179b65a5794`. Где `/dev/mapper/local-root` это путь к вашему диску и это значение вам нужно записать в параметр `resume device =` файла `/etc/uswsusp.conf`. Например:
```
resume device = /dev/mapper/local-root
```

### 3. Указываем swapfile системе

На деле не смотря на указание `resume device =`, устройства пробуждения на котором расположен `/swapfile`, при выходе из спящего режима **uswsusp** все равно не видит его (тут я говорю uswsusp, потому что это должна быть забота этой утилиты, чтобы система видел swap).

Поэтому **указываем системе диск с которого нужно загрузиться при выходе из Hibernation:**
1. Получить **UUID** диска на котором swapfile: `sudo findmnt -no SOURCE,UUID -T /swapfile`
2. Открыть файл `sudo geany /etc/initramfs-tools/conf.d/resume`
3. Вставить в `/etc/initramfs-tools/conf.d/resume` код:
    ```
    RESUME=UUID=81bb07cd-d495-4733-be81-3447f9161f33
    ```
    где **81bb07cd-d495-4733-be81-3447f9161f33** это вывод команды `sudo findmnt -no SOURCE,UUID -T /swapfile`
4. Сохранить файл, закрыть и выполнить: `sudo update-initramfs -u`

**Note:** можно совместить этот шаг с предыдущим шагом, чтобы 2-ва раза не выполнять команду `sudo update-initramfs -u`. Но возможно в будущем утилита **uswsusp** будет исправлена и этот шаг не нужно будет выполнять совсем.

### 3. Заменяем стандартную функцию hibernation утилитой uswsusp
1.  Копируем настройки:
        `sudo cp /lib/systemd/system/systemd-hibernate.service /etc/systemd/system/`
2.  Открываем файл настроек:
        `sudo geany /etc/systemd/system/systemd-hibernate.service`
3.  Заменить последнюю линию начинающеюся с `ExecStart=...` на это:
    ```
    ExecStart=/bin/sh -c 's2disk && run-parts --regex .\* -a post /lib/systemd/system-sleep'
    ```
    **Например** так (закоментировав старую строку поставив перед ней `#`):
    ```
    [Service]
    Type=oneshot
    # ExecStart=/lib/systemd/systemd-sleep hibernate
    ExecStart=/bin/sh -c 's2disk && run-parts --regex .\* -a post /lib/systemd/system-sleep'
    ```

4.  Перезагрузить systemd:
        `sudo systemctl daemon-reload`
5.  Тестируем:
        `sudo systemctl hibernate`

# 2. Добавляем hibernation в пункты меню питания системы
1. Открываем файл для редактирования:
   ```bash
   sudo geany /var/lib/polkit-1/localauthority/10-vendor.d/com.ubuntu.desktop.pkla
    ```
2. Найти эти пункты:
    ```bash
    [Disable hibernate by default in upower]
    [Disable hibernate by default in logind]
    ```
3. Найти внизу этих пунктов слово **ResultActive=no** и заменить на **ResultActive=yes**. Файл сохранить. Систему перезагрузить.

# 3. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)
 1. Открыть файл: `sudo geany /etc/default/grub`
 2. Закомментировать `GRUB_HIDDEN_TIMEOUT` (если она есть) поставив перед ней символ `#`. **Пример:** `#GRUB_HIDDEN_TIMEOUT=0`
 3. Установить `GRUB_TIMEOUT` в количество нужных секунд после которых загрузится система.
 4. Добавить строку `GRUB_RECORDFAIL_TIMEOUT` и установить значение равное значению из `GRUB_TIMEOUT`.
 5. Сохранить файл и выполнить `sudo update-grub`

**Пример** (кусок файла `/etc/default/grub`):
```
#GRUB_HIDDEN_TIMEOUT=0
GRUB_TIMEOUT=1
GRUB_RECORDFAIL_TIMEOUT=1
```

# Известные проблемы
1. Если у вас KDE, то отключите в настройках питания авто приостановку воспроизведения видео и музыки. Это функция лагает.
 
