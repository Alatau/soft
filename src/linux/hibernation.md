- [Что это?](#Что-это)
- [1. Подготовка](#1-Подготовка)
- [2. Настраиваем /swapfile подкачки](#2-Настраиваем-swapfile-подкачки)
- [3. Устанавливаем размер образа системы и отключаем сжатие](#3-Устанавливаем-размер-образа-системы-и-отключаем-сжатие)
- [4. Добавляем hibernation в пункты меню питания системы](#4-Добавляем-hibernation-в-пункты-меню-питания-системы)
- [5. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)](#5-Устанавливаем-время-загрузки-системы-при-пробуждении-в-случае-проблем-чтобы-не-ждать-долго)

# Что это?

Краткая инструкция по включению Hibernation (спящего режима) в Ubuntu.

# 1. Подготовка
Устанавливаем **geany** для удобного редактирования файлов конфигурации. И просто запускаем **1-ин раз не от sudo**, иначе файл конфигураций создастся от sudo и сохранение настроек не будет доступно обычному пользователю.

Чтобы исправить проблему с сохранение конфигурации не от sudo нужно удалить файл конфигурации `sudo rm -rf /home/<user>/.config/geany` и запустить 1-ин раз не от sudo. Где `<user>` это имя вашего пользователя.
```bash
sudo apt install geany
```

# 2. Настраиваем /swapfile подкачки
**1. Увеличиваем `/swapfile` подкачки.** Это нужно чтобы образ вошедшей в hibernate системы поместился в `/swapfile`. При пробуждении образ будет восстановлен из этого файла.

**Какой размер `/swapfile` выбрать:** в 2 раза больше чем у вас оперативной памяти (вместо 16 гигабайт в команды ниже поставите нужный размер).
```bash
# смотрим информацию о памяти
free -m                             # информация о оперативной памяти

# увеличиваем до 16 Gb (выполнить команды, вместо 16 подставить свое)
sudo swapoff /swapfile              # отключаем swap
sudo fallocate -l 16G /swapfile     # увеличиваем размер swap
sudo chown root:root /swapfile      # устанавливаем владельцем root
sudo chmod 600 /swapfile            # устанавливаем права доступа
sudo mkswap /swapfile               # форматируем файл в swap тип
sudo swapon /swapfile               # включаем swap

# проверяем что получилось
sudo swapon --show                  # смотрим что создалось
free -m                             # информация о оперативной памяти
cat /proc/swaps                     # информация о состоянии swap
```

**2. Добавим точку монтирования `/swapfile` в `/etc/fstab`**, чтобы система  могла видеть swap файл и использовать его во время загрузки.

1. Открываем файл: `sudo geany /etc/fstab`
2. Увидим там строку: `/swapfile none swap sw 0 0`. Заменить ее на строку: ```/swapfile   swap    swap    defaults        0       0```
3. Сохранить файл. Перемонтировать диски из `/etc/fstab`, если там не стоит `noauto` выполнив команду: `sudo mount -a`
4. Если команда `sudo mount -a` не сработала, то на этом шаге перезагрузите систему

**3. Указываем где `/swapfile` с которого загружаться**:
1. Получить **UUID** для `/swapfile`
    ```bash
    sudo findmnt -no SOURCE,UUID -T /swapfile
    ```
2. Получить `offset` (смещение) файла `/swapfile` относительно начала диска (смотреть **первое число** в столбце `physical_offset`, это число и есть смещение):
    ```bash
    sudo filefrag -v /swapfile
    ```
3. Открыть конфигурацию grub:
    ```bash
    sudo geany /etc/default/grub
    ```
4. Найти в открытом `/etc/default/grub` слово (опцию) `GRUB_CMDLINE_LINUX_DEFAULT`. Поставить в `resume` значение **UUID**, а в `resume_offset` число **offset** (смещение), полученные выше. И добавить это вконец этой опции после знака `=` (равно) внутрь между кавычек отделив пробелом опции `resume` и `resume_offset` как в примере:
    ```bash
    GRUB_CMDLINE_LINUX_DEFAULT="quiet splash resume=UUID=e2ea34fc-b23a-4948-b2e6-a5a9a79682e5 resume_offset=34816"
    ```
5. Сохранить файл и выполнить обновление grub:
    ```bash
    sudo update-grub
    ```
6. Перезагрузить систему.

# 3. Устанавливаем размер образа системы и отключаем сжатие

**Зачем:** иначе будет тормозить при пробуждении пока недостающий кусочек памяти не загрузится в оперативную память.

**1. Устанавливаем размер образа сохраняемого в `/swapfile` равным размеру оперативной памяти (в байтах):**

0. Смотрим лимит размера образа системы: `cat /sys/power/image_size`
1. Создаем файл конфигурации `sudo touch /etc/tmpfiles.d/hibernationsize.conf`
2. Вставляем в `/etc/tmpfiles.d/hibernationsize.conf` текст конфигурации (8589934592 байт это 8 Гб, ож):
    ```
    #    Path                  Mode UID  GID  Age Argument
    w    /sys/power/image_size     -    -    -    -   8589934592
    ```
3. Сохранить файл. Перезагрузить систему

**Как посчитать нужное число:** 1 Гб это **1073741824** байт, поэтому чтобы получить количество байт для 8 Гб нужно использовать формулу: `8 * 1073741824 = 8589934592` (вместо 8 можете использовать нужное вам число Гб: 4, 8, 16, 32, ...). И именно это полученное число равное количеству гигабайт вашей оперативной памяти умноженной на число  **1073741824** нужно подставить в файл `/etc/tmpfiles.d/hibernationsize.conf` вместо 8589934592 из примера выше.

**2. Отключаем сжатие образа системы:**

1. Открываем `sudo geany /etc/default/grub`
2. Добавляем в опции ядра параметр `hibernate=nocompress`, итоговая строка:
    ```
    GRUB_CMDLINE_LINUX_DEFAULT="hibernate=nocompress resume=UUID=2f7d1692-5348-456d-9317-47147c4ef639 resume_offset=34816"
    ```
3. Обновляем конфигурацию `sudo update-grub`
4. Перезагрузить систему

# 4. Добавляем hibernation в пункты меню питания системы
1. Открываем файл для редактирования:
   ```bash
   sudo geany /var/lib/polkit-1/localauthority/10-vendor.d/com.ubuntu.desktop.pkla
    ```
2. Найти эти пункты:
    ```bash
    [Disable hibernate by default in upower]
    [Disable hibernate by default in logind]
    ```
3. Найти внизу этих пунктов слово **ResultActive=no** и заменить на **ResultActive=yes**. Файл сохранить. Систему перезагрузить.

# 5. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)
 1. Открыть файл: `sudo geany /etc/default/grub`
 2. Закомментировать `GRUB_HIDDEN_TIMEOUT` (если она есть) поставив перед ней символ `#`. **Пример:** `#GRUB_HIDDEN_TIMEOUT=0`
 3. Установить `GRUB_TIMEOUT` в количество нужных секунд после которых загрузится система.
 4. Добавить строку `GRUB_RECORDFAIL_TIMEOUT` и установить значение равное значению из `GRUB_TIMEOUT`.
 5. Сохранить файл и выполнить `sudo update-grub`

**Пример** (кусок файла `/etc/default/grub`):
```
#GRUB_HIDDEN_TIMEOUT=0
GRUB_TIMEOUT=1
GRUB_RECORDFAIL_TIMEOUT=1
```

 # Известные проблемы
 1. Если у вас KDE, то отключите в настройках питания авто приостановку воспроизведения видео и музыки. Это функция лагает.
 
