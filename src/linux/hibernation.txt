Включение hibernation в Ubuntu 18.04 (проверено на kubuntu)

0.  Установить утилиту, которая лучше работает с hibernation, чем встроенная. Поддерживает больше оборудования.
        sudo apt install uswsusp
        
1.  Чтобы образ сохраненной системы помещался при hibernation нужно увеличить размер swap (файла подкачки)
        Размер swap для своей системе выбрать по этой табл (RAM - размер вшей оперативной памяти):
            <=  2GB         размер swap будет RAM * 3
            >   2GB - 8GB   размер swap будет RAM * 2
            >   8GB - 64GB  размер swap будет RAM * 1.5
            >   64GB        размер swap будет RAM * 1
            
        Источник: https://askubuntu.com/a/420079
            
2.  Увеличиваем размер swap файла. Он должен быть не меньше размера вашей оперативной памяти.
        2.1 Проверяем наличие swap и видит ли его система (одна из строк вывода консоли должна начинаться со "Swap:")
            free -m                             # информация о оперативной памяти
        2.2 Сам swap файл расположен по пути /swapfile
        2.3 Выполняем последовательно команды ниже:
            sudo swapoff /swapfile              # отключаем swap
            sudo fallocate -l 16G /swapfile     # увеличиваем размер swap
            sudo chown root:root /swapfile      # устанавливаем владельцем пользователя root с группой root (так по умолчанию в ubuntu)
            sudo chmod 600 /swapfile            # устанавливаем права доступа (владельцу можно читать и писать, остальным запрещено всё)
            sudo mkswap /swapfile               # форматируем файл в swap тип
            sudo swapon /swapfile               # включаем swap
        2.4 Проверим все ли получилось:
            sudo swapon --show                  # смотрим что создалось
            free -m                             # информация о оперативной памяти
3.  Добавим точку монтирования swapfile в /etc/fstab, чтобы система и утилита uswsusp могли видеть swap файл и использовать его.
        3.1 Открываем файл, geany это текстовый редактор, можете использовать любой
            sudo geany /etc/fstab
        3.2 Если запись начинающаяся со /swapfile существует, то нужно отредактировать ее. Если нет, то создать новую (добавить строку), представленную ниже:
            /swapfile   swap    swap    defaults        0       0
        
            Примечание: рассмотреть возможность замены defaults на sw (права доступа)
        3.3 Перезагрузиться (возможно не нужно)
        
4.  Настраиваем утилиту uswsusp и заменяем ей стандартную функцию hibernation
        sudo dpkg-reconfigure -pmedium uswsusp
        
    4.1 В появившеся окне выполнять по шагам:
        "Continue without a valid swap space?" ответить Да
        "Swap space to resume from:" - выбрать РАЗДЕЛ на котором swapfile создан ( т.е. выбрать /swapfile )
        "Encrypt snapshot?" - лучше ответить нет
    4.2 После этого сгенерируется файл конфигурации, посмотреть его можно так:
            sudo geany /etc/uswsusp.conf
    4.3 Указываем утилите uswsusp положение swap файла
        4.3.1 Откроем конфигурацию
            sudo geany /etc/uswsusp.conf
        4.3.2 Найдем позицию в файловой системе (смещение относительно начала диска)
            sudo swap-offset /swapfile
        4.3.3 Строкой которая вывелась командой выше заменить ту что в файле /etc/uswsusp.conf, если ее там нету, то добавить вконец файла
            resume offset = 34816
        4.3.4 После редактирования /etc/uswsusp.conf нужно запустить команду
            sudo update-initramfs -u

Включение hibernation в Ubuntu 17.10 (в системах Ubuntu с swap файлом вместо swap раздела)

0. способ точно рабочий, но возможно тут путаница с шагами, иногда нужно вернуться на предыдущий шаг и повторить
1. Увеличиваем размер swap файла. Он должен быть не меньше размера вашей оперативной памяти
    1.0 Проверяем наличие swap и видит ли его система ( одна из строк вывода должна начинаться со Swap: )
        free -m
    1.1 swap файл расположен в /swapfile
    1.2.1 Какой размер swap для hibernation выбрать
        <= 2 Gb в 3 раза больше размера swap
        >  2 Gb - 8 Gb в 2 раза больше размера swap
        >  8 Gb - 64 Gb в 1.5 раза больше размера swap
        >  64 Gb - равное размеру swap
        Источник: https://askubuntu.com/a/420079
    1.2.2 Увеличим размер:
        swapoff -a
        sudo fallocate -l 9G /swapfile - в примере увеличено до 9 Gb (лучше поставить размер на 2 Gb больше размера RAM, т.к. у меня образ памяти определяет на 1.5 Gb больше занятого размера RAM)
        sudo chown root:root /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        sudo swapon --show - смотрим что создалось
    1.3 Отредактируем файл автоматинтирования при загрузке, чтобы указать там наш swapfile.
        Программа geany - тектовый редактор, подойдет любой:
        sudo geany /etc/fstab
    1.4 Вставить строку ниже в fstab или заменить, если swapfile уже существует, но имеет другие опции монтирования (одну из тех что ниже)
        /swapfile swap swap defaults 0 0 - новая строка
        /swapfile none swap sw 0 0 - строка по умолчанию
        /swapfile swap swap sw 0 0 - возможно лучше такое
    1.5 Установить какую-то странную программу
        sudo apt install uswsusp
    1.6 Проверить состояние swap
        sudo findmnt -no SOURCE,UUID -T /swapfile
    1.7 Настроить uswsusp (перед выполнением команды ниже может понадобиться ПЕРЕЗАГРУЗКА, чтобы заработал swap файл)
        sudo dpkg-reconfigure -pmedium uswsusp - Нужно выбрать /swapfile (у меня сработало)
    1.7.2 (ОСТОРОЖНО НА ЭТОМ ШАГЕ, ВОЗМОЖНО ПРИДЕТСЯ ПРОБОВАТЬ РАЗНЫЕ ОПЦИИ УЖЕ ПОСЛЕ ТОГО КАК ПРОДЕЛАЕТЕ ВСЕ ШАГИ)
        В открывшемся меню по шагам:
        1. No
        2. Выбрать: /swapfile
        3. No
    1.8 Создать или открыть файл
        sudo geany /etc/initramfs-tools/conf.d/resume
    1.9 Посмотреть UUID
        sudo swaplabel /swapfile
    1.10 вставить UUID в файл /etc/initramfs-tools/conf.d/resume в виде:
        RESUME=UUID=81bb07cd-d495-4733-be81-3447f9161f33
    1.11 выполнить
        sudo update-initramfs -u
    1.12 Перезагружаемся
    1.14 Подключаем s2disk к systemd
        sudo cp /lib/systemd/system/systemd-hibernate.service /etc/systemd/system/
        sudo geany /etc/systemd/system/systemd-hibernate.service
    1.15 заменить последнюю линию начинающуюся с ExecStart в файле /etc/systemd/system/systemd-hibernate.service на те что ниже (см. значения)
        ExecStart=/usr/sbin/s2disk
        ExceStart=run-parts -a post /lib/systemd/system-sleep
    1.16 Обновить демонов systemd
        sudo systemctl daemon-reload
        sudo systemctl hibernate - проверяем как работает hibernation
    1.17 Добавляем hibernation в пункты меню питания системы
        sudo geany /var/lib/polkit-1/localauthority/10-vendor.d/com.ubuntu.desktop.pkla
        Найти эти пункты:
            [Disable hibernate by default in upower]
            [Disable hibernate by default in logind]
        найти внизу этих пунктов ResultActive
        и поставить значение ResultActive=yes
    1.18 перезагрузиться
    1.19 Тестируем hibernation
        sudo s2disk
    
    2. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)
        sudo geany /etc/default/grub
    2.1 закоментировать GRUB_HIDDEN_TIMEOUT
        #GRUB_HIDDEN_TIMEOUT=0
    2.2 установить GRUB_TIMEOUT в количество нужных сек.
    2.3 добавить строку GRUB_RECORDFAIL_TIMEOUT и установить равное значению из GRUB_TIMEOUT
    2.4 выполнить sudo update-grub
    
    3. Если есть проблемы, то можно попробовать установить другие версии ядер. Более новые, или LTS.
        У меня лично проблемы были на ядре linux 4.13 (по умолчанию в Ubuntu 17.10), но исчезли с установкой ядра linux 4.15
        Ядра можно ставить отсюда: http://kernel.ubuntu.com/~kernel-ppa/mainline/
        
    4. Некоторые программы могут иметь версии модулей несовместимые с новыми ядрами.
        И после установки подходящего для hibernation ядра во время загрузки Ubuntu будут сообщения об ошибках.
            (можно увидеть лог нажав esc во время загрузки или набрав dmesg после)
        В этом случае нужно удалить информацию о модуле ядра вручную. Например для программы CDEmu это делается так
            1. sudo rm /etc/modules-load.d/vhba.conf
            2. Перезагрузиться
            
    5. Временная пометка. В Ubuntu 17.10 (linux 4.13) проблемы с hibernation решаются переходом на ядро 4.15
        При этом в логе можно увидеть ошибку:
            kgdskfd probe failure message
            
        Судя по статье ниже этот модуль нужен был для старого драйвера AMD, с версии 4.14 его не используют.
        Поэтому на эту ошибку внимания можно не обращать.
            https://www.phoronix.com/scan.php?page=news_item&px=AMDKFD-More-For-Linux-4.15
