Включение hibernation в Ubuntu 18.04 (проверено на kubuntu)

Кому нужна эта статья? Для linux на сегодня есть 3 вариант использования hibernation (гибернации, спящего режима):
    1. Использовать ту что идет с системой. Она отключена по умолчанию, потому что лагает. А лагает потому что производители оборудования делают его не по стандартам и система не знает точно как с ним работать. Если вам повезло, то у вас будет все работать. Хотя в ubuntu пункт в меню питания придется всеравно включить вручную, для этого смотрите пункт 8
    2. Патченное ядро и отдельные патчи, которые вы можете установить сами. Не уверен что это надежно. Можете поискать по слову Tuxonice
    3. Утилита uswsusp, для работы с ней не нужны патчи ядра. Поддерживает больше оборудования чем стандартный режим hibernation из ядра. О ней эта статья.

Если что-то непонятно, рекомендую посмотреть ссылки ниже.
Статья написана по материалам:
    Какой размер swap выбрать для hibernaion: https://askubuntu.com/a/420079
    Инструкция для ubuntu: https://askubuntu.com/a/914202
    Инструкция для debian, более надежный источник: https://wiki.debian.org/Hibernation/Hibernate_Without_Swap_Partition
    FAQ: https://help.ubuntu.com/community/SwapFaq
    Подробное и простое объяснение как работает hibernation, почему может не работать, с ссылками на ответы: https://askubuntu.com/a/1038856

Для редактирования файлов конфигурации я использую редактор geany. Чтобы его установить можно выполнить:
    sudo apt install geany
    
0.  Установить утилиту, которая лучше работает с hibernation, чем встроенная. Поддерживает больше оборудования.
        sudo apt install uswsusp
        
1.  Чтобы образ сохраненной системы помещался при hibernation нужно увеличить размер swap (файла подкачки)
    Размер swap должен быть в 2 раза больше вашей оперативной памяти. Существует формула, по которой вы можете выбрать меньше (ссылка в источнике), но по другой табл. из FAQ максимум может достигать размера в 2 раза, поэтому думаю не стоит использовать формулу.
                        
2.  Увеличиваем размер swap файла. Он должен быть не меньше размера вашей оперативной памяти.
        2.1 Проверяем наличие swap и видит ли его система (одна из строк вывода консоли должна начинаться со "Swap:")
            free -m                             # информация о оперативной памяти
        2.2 Сам swap файл расположен по пути /swapfile
        2.3 Выполняем последовательно команды ниже:
            sudo swapoff /swapfile              # отключаем swap
            sudo fallocate -l 16G /swapfile     # увеличиваем размер swap
            sudo chown root:root /swapfile      # устанавливаем владельцем пользователя root с группой root (так по умолчанию в ubuntu)
            sudo chmod 600 /swapfile            # устанавливаем права доступа (владельцу можно читать и писать, остальным запрещено всё)
            sudo mkswap /swapfile               # форматируем файл в swap тип
            sudo swapon /swapfile               # включаем swap
        2.4 Проверим все ли получилось:
            sudo swapon --show                  # смотрим что создалось
            free -m                             # информация о оперативной памяти
            cat /proc/swaps                     # информация о состоянии swap
3.  Добавим точку монтирования swapfile в /etc/fstab, чтобы система и утилита uswsusp могли видеть swap файл и использовать его во время загрузки системы.
        3.1 Открываем файл, geany это текстовый редактор, можете использовать любой
            sudo geany /etc/fstab
        3.2 Вы можете увидеть там строку по умолчанию (а может и нет?):
            /swapfile none swap sw 0 0
        3.2 Если запись начинающаяся со /swapfile существует, то нужно отредактировать ее. Если нет, то создать новую (добавить строку), представленную ниже:
            /swapfile   swap    swap    defaults        0       0
        
            Примечание: рассмотреть возможность замены defaults на sw (права доступа)
        3.3 Перезагрузиться (возможно не нужно)
        
4.  Настраиваем утилиту uswsusp.
    Команда МОЖЕТ не сработать с первого раза как надо, не все шаги появятся. Тогда запустить ее еще раз.
        sudo dpkg-reconfigure -pmedium uswsusp
        
    4.1 В появившеся окне выполнять по шагам:
        "Continue without a valid swap space?" ответить Да
        "Swap space to resume from:" - выбрать именно РАЗДЕЛ на котором swapfile создан (а не путь к файлу, т.е. выбрать /dev/sda1)
        "Encrypt snapshot?" - лучше ответить нет
    4.2 После этого сгенерируется файл конфигурации, проверить его:
            sudo geany /etc/uswsusp.conf
        4.2.1   Если одна из строк
                    resume device = /swapfile
                то значение неверно, т.к. путь к файлу должен быть в виде /dev/sda1/swapfile (или /dev/sda2/swapfile если у вас UEFI)
                А значит верный путь это: resume device = /dev/sda1
        4.2.2   Смотрим раздел на котором расположен /swapfile, результат должен быть в виде /dev/sdaN
                    sudo findmnt -no SOURCE,UUID -T /swapfile
        4.2.3   После редактирования /etc/uswsusp.conf нужно запустить команду
                    sudo update-initramfs -u
    4.3 Указываем утилите uswsusp положение swap файла
        4.3.1 Откроем конфигурацию
            sudo geany /etc/uswsusp.conf
        4.3.2 Найдем позицию в файловой системе (смещение относительно начала диска). На самом деле это номер первого блока на диске принадлежащего swapfile
            sudo swap-offset /swapfile
        4.3.3 Строкой которая вывелась командой выше заменить ту что в файле /etc/uswsusp.conf, если ее там нету, то добавить вконец файла
            resume offset = 34816
        4.3.4 После редактирования /etc/uswsusp.conf нужно запустить команду
            sudo update-initramfs -u
            
5.  Протестируем, для этого выполнить команду: sudo s2disk
    Примечание: у меня не работает с первого раза, нужно попробовать несколько раз.
    
6.  (можете пропустить этот пункт и переходить к пункту 7, потому что данный способ иногда вызывает замедление загрузки)

    Если при выходе из hibernation система загружается как при включении, и не восстанавливает свое состояние.
    То uswsusp не видит файл подкачки при загрузке. Чтобы исправить это читаем далее.
    
    6.1 Выполнить и получить UUID
        sudo swaplabel /swapfile
    6.2 Открыть sudo geany /etc/initramfs-tools/conf.d/resume
    6.3 Вставить строку в виде: RESUME=UUID=81bb07cd-d495-4733-be81-3447f9161f33
        Где 81bb07cd-d495-4733-be81-3447f9161f33 это номер, который вывелся в пункте 6.1
    6.4 Выполнить, чтобы обновить конфигурацию (при выполнении может появиться предупреждение, что swap не найден, не обращать в внимание)
            sudo update-initramfs -u
    6.5 Выполнить для теста команду:
            sudo s2disk
    6.6 Если resume device = /dev/sda2 из файла /etc/uswsusp.conf не сработал, то удалять его всеравно нельзя, иначе будет ругаться.
    
7.  Как вариант вместо пункта 6 можно сделать так.
    ТАКЖЕ это поможет быстрее загружаться, если hibernation работает, но загрузка медленнее из-за ошибки "Gave up waiting for suspend/resume device", которая может появиться из-за каких-то проблем со способом в пункте 6.
    
    Примечание: поискать решение ошибки "Gave up waiting for suspend/resume device"
    
    7.1 Открыть файл
            sudo geany /etc/default/grub
    7.2 ДОБАВИТЬ к тому что там уже есть в "GRUB_CMDLINE_LINUX_DEFAULT" строку "resume=/dev/sda1" (не забывайте что у вас может быть что-то другое вместо sda1)
            Пример: GRUB_CMDLINE_LINUX_DEFAULT="resume=/dev/sda1"
    7.3 Выполнить 
            sudo update-grub
    
7. Заменяем стандартную функцию hibernation утилитой uswsusp
    1.  Копируем настройки
            sudo cp /lib/systemd/system/systemd-hibernate.service /etc/systemd/system/
    2.  Открываем файл настроек
            sudo geany /etc/systemd/system/systemd-hibernate.service
    3.  Заменить последнюю линию начинающеюся с ExecStart на то что ниже
            ExecStart=/bin/sh -c 's2disk && run-parts --regex .\* -a post /lib/systemd/system-sleep'
    4.  Перезагрузить systemd
            sudo systemctl daemon-reload
    5.  Тестируем
            sudo systemctl hibernate
        
8. Добавляем hibernation в пункты меню питания системы
    8.1 Открываем файл
        sudo geany /var/lib/polkit-1/localauthority/10-vendor.d/com.ubuntu.desktop.pkla
    8.2 Найти эти пункты:
            [Disable hibernate by default in upower]
            [Disable hibernate by default in logind]
    8.3 найти внизу этих пунктов слово ResultActive и поставить значение ResultActive=yes
    
9. Устанавливаем время загрузки системы при пробуждении в случае проблем (чтобы не ждать долго)
    0. Открыть файл: sudo geany /etc/default/grub
    1. закомментировать GRUB_HIDDEN_TIMEOUT поставив перед ней символ #
        Пример: #GRUB_HIDDEN_TIMEOUT=0
    2. установить GRUB_TIMEOUT в количество нужных сек.
    3. добавить строку GRUB_RECORDFAIL_TIMEOUT и установить равное значению из GRUB_TIMEOUT
    4. выполнить sudo update-grub
    
10. Если hibernation всеравно не работает, а использовать хочется, то можете попробовать установить новые ядра
    http://kernel.ubuntu.com/~kernel-ppa/mainline/
    Все эти ядра нестабильны, возможны любые проблемы. Если у вас есть программы использующие модули ядра, то они могут перестать работать.
    Если модули конфликтуют, а использовать новые ядра всеравно нужно, то программы придется удалять или мириться с ошибками.
    
11. Если у вас KDE, то отключите в настройках питания авто приостановку воспроизведения видео и музыки. Это функция лагает.

12. Не знаю как в других средах, а в KDE после появления стандартного пункта в меню питание вы можете выбрать, чтобы компьютер переходил в режим hibernation если заряд батареи слишком низкий.
        
13. Не выключайте сжатие образа системы. Или по крайней мере попробуйте оба варианта. У меня со сжатием работает быстрее.
